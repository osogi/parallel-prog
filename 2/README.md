# Task-2: Инструменты анализа кода

## Выбранный проект
https://github.com/halloweeks/networking/tree/main

Простенький TCP клиент/сервер написанный на C++. В основном будем изучать [сервер](./networking/server.cpp ), так как клиент довольно простой и в нём даже нет параллельных элементов.

### Пару слов о выборе проекта
Был выбран такой небольшой и простой проект, так как в более крупных проектах инструменты анализа выдавали слишком много логов, в которых было трудно разобраться, тем более без знания кодовой базы. 

## Результаты анализа
Ошибки и предупреждения, которые выдали инструменты, представлены в файлах [helgrind.out.txt](./helgrind.out.txt) и [sanitizer.out.txt ](./sanitizer.out.txt ). Оба инструмента "предположили", что глобальная переменная `connection` может быть подвержена гонке данных. Также helgrind несколько раз поругался на внутреннюю работу `printf`, вероятно вызвано тем что в *stdout* могут писать одновременно несколько потоков.

### Изучение результатов
Если изучить код и посмотреть, где изменяется переменная `connection`, можно найти два места: 
- в коде главного потока, обрабатывающего запросы на подключение новых клиентов, при успешном подключении  `connection` увеличивается:
	```c
		} else {
		printf("[INFO] NEW THREAD CREATED\n");
		connection++;
	}
	```

- в потоках, отвечающих за работу с клиентом (принятием и отсылки данных), при завершении работы `connection` уменьшается:
	```c
	    pthread_mutex_lock(&connection_mutex);
	    connection--;
	    pthread_mutex_unlock(&connection_mutex);
	   
	    printf("[INFO] THREAD TERMINATED\n");
	```

Интересно, что по отдельности эти части кода работают хорошо. Главный поток у нас может быть только один и не сможет поэтому дважды одновременно изменить переменную. А на потоках, которых может быть много, у нас на её изменение стоит мьютекс. 

Проблема появляется именно при их взаимодействии, так как в главном потоке у нас не стоит мьютекс на `connection`, то он может изменить её в тот момент когда это же делает поток клиента, который вроде как залочил мьютекс для этой переменной. Возможный фикс: добавить лок мьютекса и для главного потока.


### Гонка данных

Для того чтобы проверить возможно ли получить гонку данных, описанную выше, был написан небольшой [файл](./racer/racer_client.c ), который должен её породить. А так же к коду сервера был добавлен вывод числа соединений (`connection`), которые он поддерживает в данный момент. 

В результате удалось получить на сервере отрицательное число текущих подключений, следовательно, файл смог создать гонку данных, следовательно, её возможно получить.

```
<...>
------------------------
[INFO] CONNECTION CLOSED
[INFO] THREAD TERMINATED
[DEBUG] CONNECTION LIVE: -1
[INFO] CONNECTION CLOSED
[INFO] THREAD TERMINATED
[DEBUG] CONNECTION LIVE: -2
[TIME] PROCESS COMPLETE IN 0.00202 SEC
------------------------
[TIME] PROCESS COMPLETE IN 0.00493 SEC
------------------------
```

## Своя гонка данных
